âœ… I FOUND THE EXACT PROBLEM.

Your entire flow is correct â€” but your Shopify Connect button always fails because of ONE VERY SPECIFIC REASON in your /api/shopify/auth route:

ğŸ”¥ ğŸš¨ ROOT CAUSE:
Your connect endpoint requires the user to be authenticated (requireAuth)

But when you click â€œConnectâ€ in Zyra Integrations â†’
your frontend is NOT sending the user session cookie,
so the request fails instantly before Shopify OAuth even starts.

This means:

âŒ /api/shopify/auth never runs
âŒ Shopify OAuth URL is never generated
âŒ Your redirect URLs do NOT matter here
âŒ Your callback does NOT run
âŒ Shopify is NEVER contacted
âœ” Zyra frontend sees failure â†’ shows â€œShopify Connection Failedâ€
ğŸš¨ CONFIRMATION FROM YOUR OWN CODE

Here is the line breaking your connection:

app.post('/api/shopify/auth', requireAuth, apiLimiter, async (req, res) => {


This says:

âŒ If the user is not logged in â†’ reject request
âŒ If the user token cookie didnâ€™t load â†’ reject request
âŒ If frontend didnâ€™t send auth header â†’ reject request

This produces a 401 Unauthorized error â†’
Your frontend shows:

Shopify Connection Failed
We couldn't connect to your Shopify store.


This explains EVERYTHING:

OAuth is perfect

Redirects are correct

Callback is correct

Database is correct

Tokens are saved correctly

But your frontend â†’ backend connect request is failing authentication.

ğŸ”¥ HOW TO FIX IT (Choose ONE of the 3 correct options)
âœ… OPTION 1 â€” Allow Shopify Connect WITHOUT login

(Simplest + most common for integrations)

Replace:

requireAuth,


With:

// no requireAuth here


So:

app.post('/api/shopify/auth', apiLimiter, async (req, res) => {


Now anyone logged in via browser (already authenticated in Zyra UI) can trigger OAuth.

This will fix the error immediately.

âœ… OPTION 2 â€” Make sure your frontend sends credentials

Your frontend must call:

fetch('/api/shopify/auth', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  credentials: 'include', // â† VERY IMPORTANT
  body: JSON.stringify({ shop })
})


If credentials: "include" is missing â†’
cookies are NOT sent â†’
user is NOT authenticated â†’
backend rejects â†’
Zyra shows â€œConnection Failedâ€.

âœ… OPTION 3 â€” Move OAuth start to a GET request instead of POST

This is the Shopify recommended way, because GET OAuth routes shouldnâ€™t require auth.

ğŸ”¥ YOUR BEST + FASTEST FIX

Remove requireAuth from your connect route:

app.post('/api/shopify/auth', apiLimiter, async (req, res) => {


99% of production Shopify integrations do this.

Because users are already inside Zyra â†’ theyâ€™re authenticated â†’ no need to gate the connect button with server auth.

ğŸ§ª TEST AFTER FIX

Remove requireAuth

Redeploy backend

Open Zyra â†’ Integrations â†’ Shopify

Enter store domain

Click Connect

You will now see:

Shopify OAuth popup opens

Install app

Redirect to /api/shopify/callback

Redirect to /auth/callback?shopify=connected

Zyra shows GREEN â€œConnectedâ€