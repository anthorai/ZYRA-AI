# Production Database Migrations Guide

## Overview

This guide explains how to run database migrations for Zyra AI in production (Vercel deployment). Migrations create and update database tables to match the application schema.

## Automatic Migrations (Recommended)

Migrations run **automatically** when your server starts. This happens on every deployment and server restart:

1. Server starts
2. **Runs migrations** ‚Üí Executes all SQL migration files in `./migrations/`
3. Initializes database (seeds subscription plans)
4. Starts serving requests

**No manual action needed** - migrations run automatically at runtime with full access to environment variables!

## Manual Migration (If Needed)

If you need to run migrations manually (e.g., to fix a database issue):

### Option 1: Run Locally Against Production Database

```bash
# Set production database URL
export DATABASE_URL="your-production-database-url"

# Run migrations
tsx scripts/migrate.ts
```

### Option 2: Trigger Vercel Redeploy

1. Go to https://vercel.com/your-project
2. Click **"Redeploy"** on the latest deployment
3. Migrations will run automatically when the server starts

### Option 3: Run via Vercel CLI

```bash
# Install Vercel CLI
npm i -g vercel

# Set environment variable
vercel env pull

# Run migration script
tsx scripts/migrate.ts
```

## Migration Files

- **Location**: `./migrations/`
- **Generated by**: `drizzle-kit generate` (already done)
- **Current migration**: `0000_nervous_tyrannus.sql`

## What Gets Created

The migration creates **37 tables** including:

### Critical Tables
- `users` - User accounts and authentication
- `store_connections` - Shopify/WooCommerce integrations
- `products` - Product catalog
- `campaigns` - Marketing campaigns
- `subscriptions` - Subscription plans and billing
- `payment_transactions` - Payment records

### Supporting Tables
- `abandoned_carts` - Cart recovery system
- `campaign_events` - Email/SMS tracking
- `ai_generation_history` - AI usage tracking
- `analytics` - Performance metrics
- `error_logs` - Application errors
- `notification_preferences` - User notification settings
- And 25 more...

## Troubleshooting

### Error: "Database connection failed"

**Cause**: `DATABASE_URL` environment variable not set or incorrect

**Fix**: 
1. Check Vercel environment variables at https://vercel.com/your-project/settings/environment-variables
2. Ensure `DATABASE_URL` is set for Production
3. Verify the connection string is correct (should start with `postgresql://`)

### Error: "Could not find the 'accessToken' column"

**Cause**: Migrations haven't run yet - database schema is outdated

**Fix**: Run migrations using any method above. This error will disappear once migrations complete.

### Error: "Migration SQL has syntax errors"

**Cause**: Database version incompatibility or corrupt migration files

**Fix**:
1. Verify you're using PostgreSQL 12+ (Supabase uses PostgreSQL 15)
2. Check migration files in `./migrations/` are intact
3. Regenerate migrations if needed: `npx drizzle-kit generate`

### Error: "Database user lacks necessary permissions"

**Cause**: Database user doesn't have CREATE TABLE permissions

**Fix**: Ensure your database user has full privileges. Supabase's default user has all permissions.

## Verifying Migrations

After deployment, check server startup logs (Vercel runtime logs or local console):

```
üîÑ Running database migrations...
üîÑ Starting database migrations...
üìç Database: xxxxx.supabase.co
üîå Connected to database
üì¶ Running migrations from ./migrations directory...
üìÑ Found 2 migration file(s)
   ‚ñ∂ Running: 0000_nervous_tyrannus.sql
   ‚úì 0000_nervous_tyrannus.sql: 0 statements executed, 168 skipped (already exist)
   ‚ñ∂ Running: 0001_fix_store_connections.sql
   ‚úì 0001_fix_store_connections.sql: 1 statements executed, 0 skipped (already exist)
‚úÖ Migrations completed successfully!
üéâ Database schema is now up to date
‚úÖ Database migrations completed
```

If you see this output, migrations ran successfully!

## Database Schema Updates

When you modify `shared/schema.ts`:

1. **Generate new migration**:
   ```bash
   npx drizzle-kit generate
   ```

2. **Test locally**:
   ```bash
   tsx scripts/migrate.ts
   ```

3. **Deploy to production**:
   ```bash
   git add .
   git commit -m "Add new database schema"
   git push
   ```

Vercel will automatically run the new migration!

## Important Notes

- ‚úÖ **Migrations are idempotent** - safe to run multiple times
- ‚úÖ **Automatic on every server start** - no manual intervention needed
- ‚úÖ **Creates missing tables only** - doesn't drop existing data
- ‚úÖ **Runtime execution** - has access to all environment variables (including DATABASE_URL)
- ‚ö†Ô∏è **Production database credentials required** - ensure `DATABASE_URL` is configured in Vercel
- ‚ö†Ô∏è **Migration errors logged but don't block startup** - server continues if migrations fail (tables may already exist)

## Support

If you encounter persistent migration issues:

1. Check Vercel deployment logs
2. Verify DATABASE_URL in Vercel settings
3. Test migration locally against a development database
4. Contact Vercel or Supabase support if database connectivity fails
