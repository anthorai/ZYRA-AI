fix the sopify manage pricing flow correct “complete fix” for a non‑embedded app is: In your app UI, user clicks “Upgrade via Shopify” on a plan.
Your app navigates to a backend route (/billing/upgrade).
That route 302‑redirects to the managed pricing page above.
Merchant picks the exact plan in Shopify’s UI.
After they approve, Shopify sends them to the Welcome link you configured per plan in the Partner Dashboard: You cannot force Shopify’s UI to pre‑select “Growth” vs “Pro” using a query parameter. The “selected plan” is purely your app’s UI concept; Shopify’s page always shows all public/private plans for the app.

What I’ll give you now is:

Final backend routes (Managed Pricing only)
Final frontend button + handler
How to wire “selected plan” UX correctly with these constraints
What to delete / stop using  
1. Backend: final Managed Pricing routes (non‑embedded app)
1.1 /billing/upgrade – main redirect route (recommended)
This is the only route your “Upgrade via Shopify” button needs. 
// Backend redirect for "Upgrade via Shopify" button (Managed Pricing only)
// Docs: https://shopify.dev/docs/apps/launch/billing/managed-pricing#plan-selection-page
app.get("/billing/upgrade", requireAuth, async (req, res) => {
  try {
    const user = (req as AuthenticatedRequest).user;

    // 1. Get store connection to find the shop domain
    const [connection] = await db
      .select()
      .from(storeConnections)
      .where(eq(storeConnections.userId, user.id));

    const rawDomain =
      connection?.storeUrl || process.env.SHOPIFY_SHOP_DOMAIN;

    if (!rawDomain) {
      console.log(
        `[BILLING] No Shopify store connected for user ${user.id}`
      );
      return res.redirect("/billing?error=no_store_connected");
    }

    // 2. Normalize into a store handle usable in:
    //    https://admin.shopify.com/store/:store_handle/charges/:app_handle/pricing_plans
    //
    // rawDomain might be:
    //   - "mystore.myshopify.com"
    //   - "https://mystore.myshopify.com"
    //   - "https://admin.shopify.com/store/mystore"
    //   - with/without trailing slash
    let storeHandle = rawDomain.trim();

    // Strip protocol
    storeHandle = storeHandle.replace(/^https?:\/\//i, "");

    // If this is an admin.shopify.com URL, extract /store/<handle>
    const adminMatch = storeHandle.match(
      /^admin\.shopify\.com\/store\/([^\/\?]+)/
    );
    if (adminMatch) {
      storeHandle = adminMatch[1];
    } else {
      // Otherwise treat it as a classic myshopify domain
      storeHandle = storeHandle
        .replace(/\.myshopify\.com.*/i, "")
        .replace(/\/$/, "");
    }

    if (!storeHandle) {
      console.error(
        `[BILLING] Could not derive storeHandle from domain "${rawDomain}" for user ${user.id}`
      );
      return res.redirect("/billing?error=invalid_store_handle");
    }

    // 3. Get Shopify App Handle from environment
    const appHandle = process.env.SHOPIFY_APP_HANDLE;
    if (!appHandle) {
      console.error("[BILLING] SHOPIFY_APP_HANDLE not configured");
      return res.redirect("/billing?error=configuration_error");
    }

    // 4. Build Managed Pricing page URL
    const managedPricingUrl = `https://admin.shopify.com/store/${storeHandle}/charges/${appHandle}/pricing_plans`;

    console.log(
      `[BILLING] Redirecting user ${user.id} to Shopify Managed Pricing: ${managedPricingUrl}`
    );

    return res.redirect(302, managedPricingUrl);
  } catch (error) {
    console.error("[BILLING] Upgrade redirect error:", error);
    return res.redirect("/billing?error=redirect_failed");
  }
}); 

1.2 /api/shopify/billing/managed-url – optional JSON version
Keep this only if you still want a JSON API that returns the URL. It uses exactly the same logic as /billing/upgrade, but returns JSON: 
// Optional: JSON API that returns the managed pricing URL instead of redirecting
app.get("/api/shopify/billing/managed-url", requireAuth, async (req, res) => {
  try {
    const user = (req as AuthenticatedRequest).user;

    const [connection] = await db
      .select()
      .from(storeConnections)
      .where(eq(storeConnections.userId, user.id));

    const rawDomain =
      connection?.storeUrl || process.env.SHOPIFY_SHOP_DOMAIN;

    if (!rawDomain) {
      console.log(
        `[BILLING] No Shopify store connected for user ${user.id}`
      );
      return res
        .status(400)
        .json({ message: "Shopify domain not found for this user" });
    }

    let storeHandle = rawDomain.trim();
    storeHandle = storeHandle.replace(/^https?:\/\//i, "");

    const adminMatch = storeHandle.match(
      /^admin\.shopify\.com\/store\/([^\/\?]+)/
    );
    if (adminMatch) {
      storeHandle = adminMatch[1];
    } else {
      storeHandle = storeHandle
        .replace(/\.myshopify\.com.*/i, "")
        .replace(/\/$/, "");
    }

    if (!storeHandle) {
      console.error(
        `[BILLING] Could not derive storeHandle from domain "${rawDomain}" for user ${user.id}`
      );
      return res.status(500).json({
        message: "Invalid Shopify store URL; unable to derive store handle",
      });
    }

    const appHandle = process.env.SHOPIFY_APP_HANDLE;
    if (!appHandle) {
      console.error("[BILLING] SHOPIFY_APP_HANDLE not configured");
      return res
        .status(500)
        .json({ message: "Shopify App Handle not configured" });
    }

    const managedPricingUrl = `https://admin.shopify.com/store/${storeHandle}/charges/${appHandle}/pricing_plans`;

    console.log(
      `[BILLING] Managed Pricing URL for user ${user.id}, storeHandle "${storeHandle}": ${managedPricingUrl}`
    );

    return res.json({ url: managedPricingUrl });
  } catch (error: any) {
    console.error("[BILLING] Managed URL error:", error);
    return res
      .status(500)
      .json({ message: error.message || "Internal server error" });
  }
}); 

1.3 Legacy /api/billing/shopify-redirect – disable manual Billing API
You should stop using appSubscriptionCreate for Managed Pricing. Convert the legacy route into either: 
// LEGACY endpoint: previously used Billing API (appSubscriptionCreate)
// Now just forwards to Managed Pricing flow.
app.get("/api/billing/shopify-redirect", requireAuth, async (req, res) => {
  try {
    const user = (req as AuthenticatedRequest).user;
    const { plan: planHandle, shop } = req.query;

    console.log(
      `[BILLING][LEGACY] /api/billing/shopify-redirect called by user ${user.id} with plan=${planHandle}, shop=${shop}. Redirecting to /billing/upgrade.`
    );

    return res.redirect(302, "/billing/upgrade");
  } catch (error: any) {
    console.error("[BILLING][LEGACY] Redirect error:", error);
    return res.status(500).json({
      message:
        error.message ||
        "Failed to redirect to Shopify managed pricing from legacy billing endpoint",
    });
  }
}); 

or hard error if you want to force callers to update: 
app.get("/api/billing/shopify-redirect", requireAuth, async (req, res) => {
  return res.status(410).json({
    message:
      "Legacy billing endpoint is no longer supported. This app now uses Shopify Managed Pricing. Use /billing/upgrade instead.",
  });
}); 
And delete the GraphQL appSubscriptionCreate code from this route so you don’t accidentally create manual charges.

 2. Frontend: final “Upgrade via Shopify” button and handler
The frontend should not call Billing API directly. It only needs to:

For trial plan → your own internal logic
For paid plans → navigate to /billing/upgrade (or call /api/shopify/billing/managed-url and redirect) 
2.1 handleUpgrade helper
Use the redirect route; keep it simple: 
const handleUpgrade = async (planHandle: string) => {
  if (!planHandle) {
    toast({
      title: "Error",
      description: "Invalid plan selection",
      variant: "destructive",
    });
    return;
  }

  try {
    // Backend handles all logic & redirects to Shopify Admin pricing page
    window.location.href = "/billing/upgrade";
  } catch (error: any) {
    console.error("[BILLING] Upgrade navigation error:", error);
    toast({
      title: "Error",
      description: error.message || "Failed to start upgrade process",
      variant: "destructive",
    });
  }
}; 
If you prefer to still go through /api/shopify/billing/managed-url, you can do: 
const handleUpgrade = async (planHandle: string) => {
  if (!planHandle) {
    toast({
      title: "Error",
      description: "Invalid plan selection",
      variant: "destructive",
    });
    return;
  }

  try {
    const response = await apiRequest("GET", "/api/shopify/billing/managed-url");
    const data = await response.json();

    if (data.url) {
      console.log(`[BILLING] Directing to Shopify Admin pricing: ${data.url}`);
      window.location.href = data.url;
    } else {
      throw new Error(data.message || "Failed to get upgrade URL");
    }
  } catch (error: any) {
    console.error("[BILLING] Managed URL error:", error);
    toast({
      title: "Error",
      description: error.message || "Failed to start upgrade process",
      variant: "destructive",
    });
  }
}; 
 Either way is fine; just make sure it’s one consistent path.

2.2 Button component onClick
Use handleUpgrade for all non‑trial plans and keep your trial logic: 
<Button
  className={`w-full px-3 sm:px-4 md:px-6 py-2.5 sm:py-3 text-xs sm:text-sm transition-all duration-200 border-0 font-semibold rounded-lg ${
    isCurrentPlan 
      ? 'bg-slate-700 text-white opacity-50 cursor-not-allowed' 
      : processingPlanId === plan.id
        ? 'bg-primary/70 text-primary-foreground cursor-wait'
        : processingPlanId !== null
          ? 'bg-slate-600 text-slate-400 cursor-not-allowed'
          : 'bg-primary text-primary-foreground hover:shadow-lg hover:shadow-primary/30 hover:scale-105 active:scale-95'
  }`}
  disabled={isCurrentPlan || processingPlanId !== null}
  onClick={() => {
    if (isCurrentPlan) return;

    // Optional: derive a "handle" to pass to handleUpgrade (for logging, etc.)
    const planAny = plan as any;
    const planHandle =
      planAny.shopifyPlanHandle ||
      (plan.planName.toLowerCase() === 'starter'
        ? 'starter'
        : plan.planName.toLowerCase() === 'growth'
        ? 'growth'
        : plan.planName.toLowerCase() === 'pro'
        ? 'pro'
        : undefined);

    if (plan.planName === "7-Day Free Trial") {
      // Internal app logic – no Shopify billing redirect
      changePlanMutation.mutate(plan.id);
      return;
    }

    // Paid plan → go to Managed Pricing page
    handleUpgrade(planHandle || "");
  }}
  data-testid={`button-choose-plan-${index}`}
>
  {processingPlanId === plan.id ? (
    <div className="w-3.5 h-3.5 sm:w-4 sm:h-4 mr-1.5 sm:mr-2 border-2 border-white/30 border-t-white rounded-full animate-spin" />
  ) : (
    <Wand2 className="w-3.5 h-3.5 sm:w-4 sm:h-4 mr-1.5 sm:mr-2" />
  )}
  <span className="truncate">
    {isCurrentPlan
      ? "Current Plan"
      : processingPlanId === plan.id
      ? "Processing..."
      : plan.planName === "7-Day Free Trial"
      ? "Start Free Trial"
      : "Upgrade via Shopify"}
  </span>
</Button> 
No temp <a> creation, no manual ?shop= parameter. Your backend already knows the store from the authenticated user. 
3. About “exact selected plan” in Admin
From Managed App Pricing docs:

Shopify gives you one plan selection page for your app.
Merchants see all public/private plans and choose.
There is no documented way to pass something like ?plan=growth to auto‑select a specific plan. 
If you need a post‑approval experience per plan, configure Welcome links in the Partner Dashboard for each plan:
Managed Pricing → Welcome links
e.g., Growth plan welcome link → https://yourapp.com/welcome?plan=growth
 4. What to remove / stop using
To have a clean Managed Pricing flow for your non‑embedded app, you should:

Remove or disable:
Any use of appSubscriptionCreate in /api/billing/shopify-redirect.
Any code that tries to build a manual Billing API confirmationUrl for core plans.
Use only:
/billing/upgrade (or /api/shopify/billing/managed-url + frontend redirect) for “Upgrade via Shopify”.
Configure Managed Pricing properly in Partner Dashboard:
Plans and pricing
Optional Welcome links per plan
With these changes in place, when a user clicks “Upgrade via Shopify”:

Frontend:
Calls handleUpgrade(...) → window.location.href = "/billing/upgrade".
Backend /billing/upgrade:
Derives storeHandle and appHandle.
302‑redirects to
https://admin.shopify.com/store/:store_handle/charges/:app_handle/pricing_plans.
Shopify:
Shows the plan selection page for your app.
After approval, redirects to the configured Welcome link for that plan.